# This playbook generates a so-colled TSD file which defines the AWX deployment
# for ATF test suites.
#
# Usage:
#
#   1. Copy the inventory file generated by Jenkins CI into the folder
#      `inventories/dev/`
#   2. `ansible-playbook -i inventories/dev/<your-inventory-filename>
#      playbooks/create_atf_tsd_file.yml`

- name: Create a ATF TSD file suitable for local executing of controller-test-suite
  hosts: localhost
  vars:
    test_suite_path: "~/repos/djulich/controller-test-suite"
    filename: "tsd_awx_devel_auto.json"
    target_file: "{{ (test_suite_path, filename) | path_join }}"
    timestamp: "{{ ansible_date_time.iso8601_basic_short }}"
    backup_filename: "{{ filename }}.{{ timestamp }}"
    backup_file: "{{ (test_suite_path, backup_filename) | path_join }}"
  tasks:
    - name: Check if target file exists
      stat:
        path: "{{ target_file }}"
      register: file_stat
    - name: Backup existing file
      copy:
        src: "{{ target_file }}"
        dest: "{{ backup_file }}"
      when: file_stat.stat.exists
    - name: Create ATF TSD file
      template:
        src: "../templates/atf_tsd.j2"
        dest: "{{ target_file }}"
